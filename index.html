<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified AI Image Generator (v3)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --accent-hover: #357abd;
            --input-bg: #3d3d3d;
            --border-color: #555;
            --error-color: #ff6b6b;
            --success-color: #4caf50;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        h1 { text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        
        /* Ë®≠ÂÆö„Ç®„É™„Ç¢ */
        .settings-box {
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .settings-header {
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings-content {
            display: none;
            margin-top: 15px;
        }
        .settings-content.open { display: block; }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }
        input[type="password"], input[type="text"], select, textarea {
            width: 100%;
            padding: 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: white;
            box-sizing: border-box;
        }

        /* „Éú„Çø„É≥È°û */
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { background-color: var(--accent-hover); }
        button:disabled { background-color: #555; cursor: not-allowed; }
        
        .btn-secondary {
            background-color: #666;
            font-size: 0.9rem;
            padding: 8px;
        }
        .btn-secondary:hover { background-color: #777; }

        /* „É°„Ç§„É≥Êìç‰Ωú„Ç®„É™„Ç¢ */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        /* ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ */
        #status-log {
            margin-top: 20px;
            padding: 10px;
            font-family: monospace;
            background: #000;
            color: #0f0;
            border-radius: 4px;
            min-height: 40px;
            white-space: pre-wrap;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        #result-area {
            margin-top: 20px;
            text-align: center;
        }
        img#generated-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: none;
        }
        
        .error-msg { color: var(--error-color) !important; }
        .success-msg { color: var(--success-color) !important; }
    </style>
</head>
<body>

<div class="container">
    <h1>Unified AI Image Generator</h1>

    <div class="settings-box">
        <div class="settings-header" onclick="toggleSettings()">
            <span>‚öôÔ∏è API Key Settings & Debug</span>
            <span>‚ñº</span>
        </div>
        <div class="settings-content" id="settings-content">
            <div class="input-group">
                <label>OpenAI API Key (DALL-E 3)</label>
                <input type="password" id="openai-key" placeholder="sk-...">
            </div>
            <div class="input-group">
                <label>Google API Key (Gemini/Imagen)</label>
                <input type="password" id="google-key" placeholder="AIza...">
                <button class="btn-secondary" onclick="checkGoogleModels()">üîç Check Available Google Models</button>
            </div>
            <div class="input-group">
                <label>xAI API Key (Grok)</label>
                <input type="password" id="xai-key" placeholder="xai-...">
            </div>
            <button onclick="saveKeys()" style="background-color: var(--success-color);">Save Keys locally</button>
        </div>
    </div>

    <div class="control-panel">
        <div class="input-group">
            <label>Provider</label>
            <select id="provider-select">
                <option value="gemini">Google (Imagen 3)</option>
                <option value="openai">OpenAI (DALL-E 3)</option>
                <option value="grok">xAI (Grok-2)</option>
            </select>
        </div>

        <div class="input-group">
            <label>Prompt</label>
            <textarea id="prompt-input" rows="3" placeholder="Describe the image you want (e.g. A futuristic samurai robot)"></textarea>
        </div>

        <div class="checkbox-group">
            <input type="checkbox" id="enhance-toggle" checked>
            <label for="enhance-toggle">Enhance Prompt with AI (LLM)</label>
        </div>

        <button id="generate-btn" onclick="startGeneration()">Generate Image</button>
    </div>

    <div id="status-log">Ready...</div>
    <div id="result-area">
        <img id="generated-image" alt="Generated Result">
        <br><br>
        <a id="download-link" href="#" download="generated_image.png" style="display:none; color: #4a90e2;">Download Image</a>
    </div>
</div>

<script>
    // --- ÂàùÊúüÂåñ„Å®„Ç≠„ÉºÁÆ°ÁêÜ ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('openai-key').value = localStorage.getItem('openai_key') || '';
        document.getElementById('google-key').value = localStorage.getItem('google_key') || '';
        document.getElementById('xai-key').value = localStorage.getItem('xai_key') || '';
    });

    function toggleSettings() {
        document.getElementById('settings-content').classList.toggle('open');
    }

    function saveKeys() {
        localStorage.setItem('openai_key', document.getElementById('openai-key').value);
        localStorage.setItem('google_key', document.getElementById('google-key').value);
        localStorage.setItem('xai_key', document.getElementById('xai-key').value);
        log("API Keys saved to Local Storage.", "success-msg");
        // Ë®≠ÂÆöÁîªÈù¢„ÇíÈñâ„Åò„Çã
        document.getElementById('settings-content').classList.remove('open');
    }

    function log(msg, className = "") {
        const logArea = document.getElementById('status-log');
        logArea.innerHTML = `<span class="${className}">${msg}</span>`;
        console.log(msg);
    }

    // --- Google„É¢„Éá„É´Á¢∫Ë™çÊ©üËÉΩ ---
    async function checkGoogleModels() {
        const apiKey = document.getElementById('google-key').value;
        if (!apiKey) {
            log("Error: Please enter Google API Key first.", "error-msg");
            return;
        }
        
        log("Checking available Google models...", "");
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await res.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            let foundImagen = false;
            let msg = "--- Available Models ---\n";
            
            // ÂèñÂæó„Åß„Åç„Åü„É¢„Éá„É´‰∏ÄË¶ß„ÇíË°®Á§∫
            data.models.forEach(m => {
                // ÁîªÂÉèÁîüÊàê„ÇÑ„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê„Å´Èñ¢ÈÄ£„Åô„Çã„ÇÇ„ÅÆ„Å†„Åë„Éî„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                if(m.name.includes("gemini") || m.name.includes("imagen")) {
                    msg += `‚Ä¢ ${m.name.replace("models/", "")}\n`;
                    if (m.name.includes("imagen")) foundImagen = true;
                }
            });
            
            msg += "\n------------------------\n";
            if (foundImagen) {
                msg += "‚úÖ 'imagen' model found! You can generate images.";
                log(msg, "success-msg");
            } else {
                msg += "‚ö†Ô∏è 'imagen' model NOT found.\nYour API key does not have access to image generation yet.\nPlease use OpenAI or Grok instead.";
                log(msg, "error-msg");
            }

        } catch (e) {
            log(`Error checking models: ${e.message}`, "error-msg");
        }
    }

    // --- „É°„Ç§„É≥Âá¶ÁêÜ ---
    async function startGeneration() {
        const btn = document.getElementById('generate-btn');
        const img = document.getElementById('generated-image');
        const downloadLink = document.getElementById('download-link');
        
        btn.disabled = true;
        img.style.display = 'none';
        downloadLink.style.display = 'none';

        const provider = document.getElementById('provider-select').value;
        const prompt = document.getElementById('prompt-input').value;
        const useEnhance = document.getElementById('enhance-toggle').checked;

        if (!prompt) {
            log("Error: Please enter a prompt.", "error-msg");
            btn.disabled = false;
            return;
        }

        const apiKey = getApiKey(provider);
        if (!apiKey) {
            log(`Error: API Key for ${provider} is missing. Please check settings.`, "error-msg");
            btn.disabled = false;
            return;
        }

        try {
            let finalPrompt = prompt;

            // 1. „Éó„É≠„É≥„Éó„ÉàÂº∑Âåñ„Éï„Çß„Éº„Ç∫
            if (useEnhance) {
                log(`[${provider}] Enhancing prompt with AI...`);
                try {
                    finalPrompt = await enhancePrompt(provider, apiKey, prompt);
                    log(`‚ú® Enhanced Prompt: ${finalPrompt}`);
                } catch (e) {
                    log(`‚ö†Ô∏è Prompt enhancement failed: ${e.message}. Using original prompt.`, "error-msg");
                    finalPrompt = prompt;
                }
            }

            // 2. ÁîªÂÉèÁîüÊàê„Éï„Çß„Éº„Ç∫
            log(`[${provider}] Generating image...`);
            const imageUrl = await generateImage(provider, apiKey, finalPrompt);

            // 3. Ë°®Á§∫
            img.src = imageUrl;
            img.style.display = 'block';
            
            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„É™„É≥„ÇØ
            try {
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                downloadLink.href = blobUrl;
                downloadLink.style.display = 'inline-block';
            } catch (e) {
                downloadLink.href = imageUrl;
                downloadLink.target = "_blank";
                downloadLink.style.display = 'inline-block';
            }

            log("Success! Image generated.", "success-msg");

        } catch (error) {
            log(`Error: ${error.message}`, "error-msg");
        } finally {
            btn.disabled = false;
        }
    }

    function getApiKey(provider) {
        if (provider === 'openai') return localStorage.getItem('openai_key');
        if (provider === 'gemini') return localStorage.getItem('google_key');
        if (provider === 'grok') return localStorage.getItem('xai_key');
        return null;
    }

    // --- APIÂëº„Å≥Âá∫„Åó„É≠„Ç∏„ÉÉ„ÇØ ---

    async function enhancePrompt(provider, apiKey, rawPrompt) {
        const systemMsg = "You are an expert image prompt generator. Expand the user's input into a detailed, descriptive English prompt (max 3 sentences). Output ONLY the prompt.";
        
        if (provider === 'openai' || provider === 'grok') {
            const baseUrl = provider === 'grok' ? 'https://api.x.ai/v1' : 'https://api.openai.com/v1';
            const model = provider === 'grok' ? 'grok-2-latest' : 'gpt-4o'; 

            const res = await fetch(`${baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        {role: "system", content: systemMsg},
                        {role: "user", content: rawPrompt}
                    ]
                })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return data.choices[0].message.content;

        } else if (provider === 'gemini') {
            // „Éó„É≠„É≥„Éó„ÉàÁîüÊàê„Å´„ÅØÊ±éÁî®ÁöÑ„Å™Gemini ProÁ≥ª„Çí‰ΩøÁî®
            // gemini-1.5-flash „Åæ„Åü„ÅØ gemini-pro „ÇíË©¶Ë°å
            let model = "gemini-1.5-flash-001";
            let url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            let res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `${systemMsg}\nUser Input: ${rawPrompt}` }] }]
                })
            });
            let data = await res.json();
            
            // Flash„ÅßÂ§±Êïó„Åó„Åü„ÇâPro„ÇíË©¶„ÅôÔºàÂÜçË©¶Ë°å„É≠„Ç∏„ÉÉ„ÇØÔºâ
            if (data.error) {
                console.warn("Flash model failed, trying Pro model...");
                model = "gemini-pro";
                url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${systemMsg}\nUser Input: ${rawPrompt}` }] }]
                    })
                });
                data = await res.json();
            }

            if (data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        }
        return rawPrompt;
    }

    async function generateImage(provider, apiKey, prompt) {
        if (provider === 'openai' || provider === 'grok') {
            const baseUrl = provider === 'grok' ? 'https://api.x.ai/v1' : 'https://api.openai.com/v1';
            const model = provider === 'grok' ? 'grok-2-image-gen' : 'dall-e-3'; 

            const body = {
                model: model,
                prompt: prompt,
                n: 1,
                size: "1024x1024",
                response_format: "url" 
            };

            const res = await fetch(`${baseUrl}/images/generations`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(body)
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            return data.data[0].url;

        } else if (provider === 'gemini') {
            // Imagen 3 endpoint
            // Ê≥®ÊÑè: „Ç®„É©„Éº„ÅåÂá∫„ÇãÂ†¥Âêà„ÅØ„Åì„Åì„ÅßÊåáÂÆö„Åó„Å¶„ÅÑ„Çã„É¢„Éá„É´ID„Åå„Ç¢„Ç´„Ç¶„É≥„Éà„Å´Ë®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì
            const url = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-001:predict?key=${apiKey}`;
            
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    instances: [{ prompt: prompt }],
                    parameters: { sampleCount: 1, aspectRatio: "1:1" }
                })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            
            if (data.predictions && data.predictions[0].bytesBase64Encoded) {
                return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
            } else if (data.predictions && data.predictions[0].mimeType) {
                 return `data:${data.predictions[0].mimeType};base64,${data.predictions[0].bytesBase64Encoded}`;
            }
            throw new Error("Unexpected response format from Google Imagen");
        }
    }
</script>

</body>
</html>